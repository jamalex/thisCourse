_ = require("underscore")
async = require("async")
analytics = require("../api/analytics")
api = require("../api/api")
redis = require("redis").createClient()
students = require("./students.coffee")
# students = ["test", "admin"]

probeanswers = {}

api.db.collection("course").findOne _id: new api.ObjectId("4f78e9a5e6ef81971e000001"), (err, course) =>    
    course.nuggets.forEach (nugget) =>
        if nugget.examquestions
            nugget.examquestions.forEach (probe) =>
                id = probe._id.toString()
                if id.length isnt 24
                    console.log id.length, id, typeof id
                    return
                api.db.collection("probe").findOne _id: new api.ObjectId(id), (err, fullprobe) =>
                    probeanswers[id] = fullprobe.answers
                    # if not _.isString(probeanswers[id])
                    # probeanswers[id] = probeanswers[id]._id
                    # else
                        # console.log fullprobe.answers

                    # fullprobe.answers.forEach (answer) =>
                    #     nuggetpoints[nugget._id] += answer.correct or 0
        

addScores = =>
    analytics.db.collection("midterm").find(type: "proberesponse").toArray (err, midtermresponses) =>
        midtermresponses.forEach (response) =>
            if probeanswers[response.probe]
                response.totalanswers = probeanswers[response.probe].length
                correct = (answer._id.toString() for answer in probeanswers[response.probe] when answer.correct)
                response.totalanswerscorrect = correct.length
                response.givenanswers = response.answers.length
                response.givenanswerscorrect = _.intersection(response.answers,correct).length
                response.points = Math.max(0, response.givenanswerscorrect - Math.max(0, response.givenanswers - response.totalanswerscorrect))
                # if response.points == 0
                #     console.log (typeof(answer._id) for answer in probeanswers[response.probe]), (typeof(id) for id in response.answers)
                analytics.db.collection("midterm").save(response)

setTimeout addScores, 2000

# // JS: 
# people = db.midterm.group({key: {email: true}, cond: {type: "proberesponse", timestamp: {$gte: start}}, initial: {points: 0, max: 0}, reduce: function(response, agg) {agg.points += response.points; agg.max += response.totalanswerscorrect;}, finalize: function(agg) {agg.percent = 100 * agg.points / agg.max;}})

# # coffee
# top = (person for person in people when person.points > 250)

probenuggets = { '517f1f95c66fa27916001355': '4f79de11ebfd0b4b31000001','517f2009c66fa27916001357': '4f79de11ebfd0b4b31000001','517f2072c66fa2791600135b': '4f79de11ebfd0b4b31000001','517f15b8ad03786d160013e3': '4f79de15ebfd0b4b3100000f','517f00b6c66fa2791600124a': '4f79de16ebfd0b4b31000014','517f02c4c66fa27916001267': '4f79de16ebfd0b4b31000014','517f03d2c66fa2791600127a': '4f79de16ebfd0b4b31000014','517f0418c66fa2791600127d': '4f79de16ebfd0b4b31000014','517f044cad03786d16001334': '4f79de16ebfd0b4b31000014','517f05b115b54567160012aa': '4f79de19ebfd0b4b3100001f','517f06a7ad03786d16001352': '4f79de19ebfd0b4b3100001f','517f0729c66fa279160012a1': '4f79de19ebfd0b4b3100001f','517f07cbc66fa279160012aa': '4f79de19ebfd0b4b3100001f','517f099bf82c1473160012dc': '4f79de1debfd0b4b3100002d','517f09e115b54567160012e1': '4f79de1debfd0b4b3100002d','517f0a34ad03786d1600136e': '4f79de1debfd0b4b3100002d','517f0cdb15b54567160012fc': '4f79de1febfd0b4b31000032','517f0d8ec66fa279160012d4': '4f79de1febfd0b4b31000032','517f0dfbc66fa279160012d8': '4f79de1febfd0b4b31000032','517f109815b5456716001327': '4f79de23ebfd0b4b31000043','517f113dad03786d160013bd': '4f79de23ebfd0b4b31000043','517f11fe15b5456716001339': '4f79de23ebfd0b4b31000043','517f127ef82c147316001336': '4f79de23ebfd0b4b31000043','517f128c15b5456716001340': '4f79de23ebfd0b4b31000043','517f13a9c66fa27916001319': '4f79de23ebfd0b4b31000043','517f18edad03786d160013f4': '4f79de2aebfd0b4b3100005a','517f1954ad03786d160013f9': '4f79de2aebfd0b4b3100005a','517f19b9f82c147316001377': '4f79de2aebfd0b4b3100005a','517f1a0315b5456716001372': '4f79de2aebfd0b4b3100005a','517f1a78ad03786d16001402': '4f79de2aebfd0b4b3100005a','517f1b58ad03786d16001409': '4f79de31ebfd0b4b31000074','517f1b8ff82c147316001383': '4f79de31ebfd0b4b31000074','517f1bd415b545671600137f': '4f79de31ebfd0b4b31000074','517f1c1aad03786d1600140f': '4f79de31ebfd0b4b31000074','517f1c5d15b5456716001383': '4f79de31ebfd0b4b31000074','517f1c9ec66fa27916001348': '4f79de31ebfd0b4b31000074','517f1d2215b5456716001388': '4f79de31ebfd0b4b31000074','517f1d85f82c147316001391': '4f79de31ebfd0b4b31000074','517f1dd3c66fa2791600134f': '4f79de31ebfd0b4b31000074','518da930c66fa2791600d694': '4f79de33ebfd0b4b31000079','518daa0ec66fa2791600d696': '4f79de33ebfd0b4b31000079','518daba6f82c14731600d72d': '4f79de36ebfd0b4b31000084','518dae3ec66fa2791600d69a': '4f79de39ebfd0b4b3100008c','518db080c66fa2791600d69b': '4f79de3bebfd0b4b31000094','5183ecf8c66fa27916002257': '4f79de40ebfd0b4b310000a4','5183ecf9f82c1473160022c6': '4f79de40ebfd0b4b310000a4','5183ede7ad03786d16002359': '4f79de42ebfd0b4b310000ac','5183ede815b5456716002283': '4f79de42ebfd0b4b310000ac','5183edf1c66fa2791600225c': '4f79de42ebfd0b4b310000ac','5183edf2f82c1473160022d1': '4f79de42ebfd0b4b310000ac','5183edfbc66fa2791600225d': '4f79de42ebfd0b4b310000ac','5183edfcf82c1473160022d2': '4f79de42ebfd0b4b310000ac','517f70f0ad03786d16001606': '4f79de54ebfd0b4b310000e4','517f713df82c147316001574': '4f79de54ebfd0b4b310000e4','517f7183c66fa27916001533': '4f79de57ebfd0b4b310000ef','517f6f1aad03786d160015ff': '4f79de5aebfd0b4b310000f7','517f6fd315b5456716001579': '4f79de5aebfd0b4b310000f7','517dfdcaad03786d16000f7f': '4f79de6aebfd0b4b31000129','517dfeddad03786d16000f83': '4f79de6aebfd0b4b31000129','517c59a6c66fa27916000cb4': '4f79de6cebfd0b4b3100012e','517f5c05c66fa27916001452': '4f79de6cebfd0b4b3100012e','517f5c75ad03786d16001527': '4f79de6cebfd0b4b3100012e','517f5ca8f82c14731600149e': '4f79de6cebfd0b4b3100012e','517f5cf4c66fa27916001461': '4f79de6cebfd0b4b3100012e','517f5d52c66fa27916001467': '4f79de6cebfd0b4b3100012e','517f5dd915b54567160014bf': '4f79de6cebfd0b4b3100012e','517f5e3bad03786d16001543': '4f79de6cebfd0b4b3100012e','517f5e83ad03786d16001546': '4f79de6cebfd0b4b3100012e','517f5ee315b54567160014cf': '4f79de6cebfd0b4b3100012e','517f5f14ad03786d1600154b': '4f79de6cebfd0b4b3100012e','517f6190ad03786d16001565': '4f79de70ebfd0b4b3100013c','517f61e015b54567160014f8': '4f79de70ebfd0b4b3100013c','5183eff6c66fa27916002279': '4f79de86ebfd0b4b31000177','5183eff7f82c1473160022e9': '4f79de86ebfd0b4b31000177','5183f0a1f82c1473160022f6': '4f79de8debfd0b4b3100018b','517e1242ad03786d16001006': '4f79de90ebfd0b4b31000193','5183f203ad03786d160023b5': '4f79de94ebfd0b4b3100019e','5183f11fad03786d16002397': '4f79de98ebfd0b4b310001a6','5183f12015b54567160022c3': '4f79de98ebfd0b4b310001a6','5183f3adad03786d160023d1': '4f79de9debfd0b4b310001b4','5183f3aef82c14731600233a': '4f79de9debfd0b4b310001b4','5183f3aead03786d160023d2': '4f79de9debfd0b4b310001b4','5183f454ad03786d160023dd': '4f79de9debfd0b4b310001b4','5183f45515b5456716002303': '4f79de9debfd0b4b310001b4','5183f488c66fa279160022dc': '4f79de9debfd0b4b310001b4','5183f4b9f82c147316002344': '4f79de9debfd0b4b310001b4','5183f327c66fa279160022cb': '4f79dea4ebfd0b4b310001c5','5183f2cdf82c14731600232b': '4f79dea9ebfd0b4b310001d3','517e08a4ad03786d16000fbd': '4f79deacebfd0b4b310001d8','517dd4c015b5456716000e73': '4f79deaeebfd0b4b310001dd','517dd8c5ad03786d16000ee3': '4f79deb1ebfd0b4b310001e5','517e0cccc66fa27916000f60': '4f79deb5ebfd0b4b310001ed','517df53df82c147316000ed4': '4f79deb7ebfd0b4b310001f2','517df6d515b5456716000ecb': '4f79deb7ebfd0b4b310001f2','51847ec8ad03786d1600269c': '4f79deb7ebfd0b4b310001f2','517dde8af82c147316000ea0': '4f79dec1ebfd0b4b3100020b','517dfa44ad03786d16000f5c': '4f79dec5ebfd0b4b31000216','517de288f82c147316000eaf': '4f79dec8ebfd0b4b3100021b','517de426ad03786d16000f05': '4f79dec8ebfd0b4b3100021b','517dc98215b5456716000e4b': '4f79decbebfd0b4b31000223','517dc8f5f82c147316000e6a': '4f79deceebfd0b4b3100022b','517dc7b115b5456716000e46': '4f79ded1ebfd0b4b31000230','517e1d29ad03786d1600102c': '4f79ded4ebfd0b4b31000238','517e1f6515b5456716000fbd': '4f79ded7ebfd0b4b3100023d','517f031e15b545671600128a': '4f79dedcebfd0b4b31000248','517f03c8ad03786d1600132f': '4f79dedcebfd0b4b31000248','517f085015b54567160012cd': '4f79dedfebfd0b4b31000250','517f0916f82c1473160012d4': '4f79dedfebfd0b4b31000250','517ffcfcf82c1473160015ec': '4f79dee5ebfd0b4b3100025e','517ffb6cf82c1473160015da': '4f79dee7ebfd0b4b31000263','517ffc7e15b54567160015f9': '4f79dee7ebfd0b4b31000263','517ff9e5c66fa27916001598': '4f79deeeebfd0b4b31000274','517ffa2cc66fa2791600159b': '4f79deeeebfd0b4b31000274','517ffa7af82c1473160015cf': '4f79deeeebfd0b4b31000274','517ffaab15b54567160015e1': '4f79deeeebfd0b4b31000274','517ff84915b54567160015d1': '4f79def3ebfd0b4b3100027f','517481da15b54567160003c0': '4f79def7ebfd0b4b31000287','517482f0c66fa279160003bf': '4f79defeebfd0b4b31000297','517efadcf82c147316001242': '4f79df08ebfd0b4b310002ab','517efb2ead03786d160012de': '4f79df08ebfd0b4b310002ab','517efc94c66fa27916001225': '4f79df08ebfd0b4b310002ab','517f14a5f82c147316001351': '4f79df0bebfd0b4b310002b0','517e179d15b5456716000fa0': '4f79df0eebfd0b4b310002b5','517e191515b5456716000fa4': '4f79df0eebfd0b4b310002b5','517f6104c66fa27916001493': '4f79df13ebfd0b4b310002c0','517f6161f82c1473160014da': '4f79df13ebfd0b4b310002c0','517f691715b545671600154a': '4f79df13ebfd0b4b310002c0','51745b95f82c147316000363': '4f79df1eebfd0b4b310002d9','517f627715b54567160014fd': '4f79df22ebfd0b4b310002e1','517f6339ad03786d1600157a': '4f79df22ebfd0b4b310002e1','517f63ebf82c1473160014f3': '4f79df22ebfd0b4b310002e1','517f64fa15b5456716001510': '4f79df22ebfd0b4b310002e1','517e164fc66fa27916000f95': '4f79df2aebfd0b4b310002f2','517f6ae4c66fa2791600150a': '4f79df2cebfd0b4b310002f7','517f6bcec66fa27916001511': '4f79df2cebfd0b4b310002f7','517e19d4c66fa27916000fa4': '4f79df79ebfd0b4b31000305','517e1b6fad03786d16001027': '4f79df79ebfd0b4b31000305','516f5e38c66fa2791600000c': '4f79df7debfd0b4b3100030d','516f76e915b545671600002b': '4f79df7debfd0b4b3100030d','516f7a0115b545671600002e': '4f79df7debfd0b4b3100030d','517f0106ad03786d16001312': '4f79df84ebfd0b4b3100031b','51741455f82c147316000347': '4f79df91ebfd0b4b31000334','5174154215b545671600034b': '4f79df91ebfd0b4b31000334','517415f5f82c147316000348': '4f79df91ebfd0b4b31000334','5174169bad03786d1600034f': '4f79df91ebfd0b4b31000334','516f7f34f82c14731600005c': '4f79df99ebfd0b4b31000344','5173f4d0f82c147316000333': '4f79df9eebfd0b4b3100034c','5173ed5915b545671600032a': '4f79dfa3ebfd0b4b31000357','518db178f82c14731600d72f': '4f79dfa6ebfd0b4b3100035c','517f0540ad03786d1600133d': '4f79dfadebfd0b4b3100036a','517f063aad03786d1600134d': '4f79dfadebfd0b4b3100036a','517f0741c66fa279160012a2': '4f79dfadebfd0b4b3100036a','51749d9fad03786d160003ea': '4f79dfc3ebfd0b4b3100038b','5174a1e9c66fa279160003ed': '4f79dfc7ebfd0b4b31000390','5174a30715b54567160003ee': '4f79dfcbebfd0b4b31000395','5174a663ad03786d160003fd': '4f79dfcfebfd0b4b3100039d','5174c9adf82c147316000438': '4f79dfd3ebfd0b4b310003a2','5174ca78c66fa2791600043f': '4f79dfd3ebfd0b4b310003a2','5174cbb4ad03786d1600043a': '4f79dfd3ebfd0b4b310003a2','5174cc48ad03786d1600043c': '4f79dfd3ebfd0b4b310003a2','5174ccbac66fa27916000440': '4f79dfd3ebfd0b4b310003a2','5174cda2f82c14731600043b': '4f79dfd3ebfd0b4b310003a2','51741839ad03786d16000353': '4f79dfe7ebfd0b4b310003c7','51771fd515b54567160006ef': '4f79dff2ebfd0b4b310003d9','51772088c66fa279160006fe': '4f79dff2ebfd0b4b310003d9','5176ee4fc66fa279160006c8': '4f79dff8ebfd0b4b310003e4','51748bb9c66fa279160003d2': '4f79e000ebfd0b4b310003f1','51741927ad03786d16000356': '4f79e003ebfd0b4b310003f6','51741a10ad03786d16000357': '4f79e003ebfd0b4b310003f6','51741a88ad03786d16000358': '4f79e003ebfd0b4b310003f6','5173fdae15b545671600033a': '4f79e00bebfd0b4b31000404','517411c2f82c147316000340': '4f79e00bebfd0b4b31000404','51749c53ad03786d160003e8': '4f79e010ebfd0b4b3100040f','5173f87dad03786d1600033b': '4f79e014ebfd0b4b31000414','5173f97715b5456716000330': '4f79e014ebfd0b4b31000414','5173fa04f82c147316000336': '4f79e014ebfd0b4b31000414','5173fad515b5456716000333': '4f79e014ebfd0b4b31000414','5173fc2ac66fa2791600033f': '4f79e014ebfd0b4b31000414','51749b0c15b54567160003e3': '4f79e018ebfd0b4b3100041c','5174806ef82c1473160003be': '4f79e01cebfd0b4b31000421','517480f8c66fa279160003b8': '4f79e01cebfd0b4b31000421','51747858ad03786d160003b2': '4f79e01febfd0b4b31000426','5174793df82c1473160003ab': '4f79e01febfd0b4b31000426','517479bb15b54567160003a8': '4f79e01febfd0b4b31000426','51747c9e15b54567160003ab': '4f79e01febfd0b4b31000426','51747cf015b54567160003ac': '4f79e01febfd0b4b31000426','51747e0bc66fa279160003ad': '4f79e024ebfd0b4b3100042e','51747ed4c66fa279160003ae': '4f79e024ebfd0b4b3100042e','51747f7fad03786d160003c0': '4f79e024ebfd0b4b3100042e','51747471f82c1473160003a3': '4f79e027ebfd0b4b31000433','51749d0c15b54567160003e6': '4f79e02aebfd0b4b31000438','518db2d3ad03786d1600d684': '4f79e02debfd0b4b3100043d','518db55115b545671600d707': '4f79e02debfd0b4b3100043d','518db78315b545671600d708': '4f79e032ebfd0b4b31000445','518db80215b545671600d709': '4f79e032ebfd0b4b31000445','518db87ff82c14731600d735': '4f79e032ebfd0b4b31000445','517f0ae2f82c1473160012e7': '4f79e03aebfd0b4b31000453','517f0a22ad03786d1600136c': '4f79e03debfd0b4b31000458','517700d8f82c1473160006f3': '4f9ee28c2a198b3138000f2c','51770201f82c1473160006f4': '4f9ee28c2a198b3138000f2c','51770266f82c1473160006f5': '4f9ee28c2a198b3138000f2c','517702b0ad03786d16000706': '4f9ee28c2a198b3138000f2c','5177036ff82c1473160006f8': '4f9ee28c2a198b3138000f2c','5178675415b5456716000857': '4f9ef7352a198b313800108d','5178675dc66fa2791600087b': '4f9ef7352a198b313800108d','517868dbc66fa2791600087e': '4f9efd112a198b31380010c9','517869ccc66fa2791600087f': '4f9efe0e2a198b31380010d6','51786a98ad03786d160008c1': '4f9eff4e2a198b31380010ed','51786af2f82c1473160008af': '4f9eff4e2a198b31380010ed','51786b7b15b545671600085b': '4f9eff4e2a198b31380010ed','51786bf5ad03786d160008c4': '4f9effee2a198b31380010fb','51786bf615b545671600085d': '4f9effee2a198b31380010fb','51786c02c66fa27916000883': '4f9effee2a198b31380010fb','51786c03f82c1473160008b1': '4f9effee2a198b31380010fb','51786c04ad03786d160008c5': '4f9effee2a198b31380010fb','5179f73515b54567160009fc': '4f9f009f2a198b3138001105','5179f8bd15b5456716000a00': '4f9f05542a198b313800114f','517abcf3c66fa27916000ae0': '4f9f05c42a198b3138001158','517abcf4f82c147316000b37': '4f9f05c42a198b3138001158','517ac42815b5456716000b04': '4f9f09892a198b31380011df','517ac42ef82c147316000b52': '4f9f09892a198b31380011df','517ac6dbad03786d16000b47': '4f9f0af22a198b3138001224','517ac7c8f82c147316000b60': '4f9f0c452a198b3138001231','517ac7d7c66fa27916000b06': '4f9f0c452a198b3138001231','517ac8e9c66fa27916000b0a': '4f9f155f2a198b31380012a7','517ac8eaf82c147316000b62': '4f9f155f2a198b31380012a7','517ac8eaad03786d16000b50': '4f9f155f2a198b31380012a7','517acb45ad03786d16000b55': '4f9f1c2e2a198b3138001353','517acb4715b5456716000b1a': '4f9f1c2e2a198b3138001353','51770476f82c1473160006fa': '4f9f1d382a198b3138001378','5177059df82c1473160006fc': '4f9f1d382a198b3138001378','517705e4ad03786d1600070d': '4f9f1d382a198b3138001378','517721c815b54567160006f8': '5150c270fb5206230a000062','517722f1c66fa2791600070b': '5150cce3400a59290a000059','51772739f82c147316000732': '5150ceb4fb5206230a000066','5177295f15b5456716000715': '5150d045617bf1390a00006e','51772ae1c66fa27916000725': '5150d146400a59290a00005e','51772c3915b5456716000719': '5150d146400a59290a00005e','517f0e9115b545671600130b': '5150d4f03fbf03310a00006c','517f0f55ad03786d1600139d': '5150d560400a59290a000061','517f107dc66fa279160012fa': '5150d5af3fbf03310a000070','517f1130c66fa27916001301': '5150d5af3fbf03310a000070','517f120715b545671600133a': '5150d63f617bf1390a00007a','517f15d415b5456716001355': '5150d6bb3fbf03310a000073','517f162dc66fa27916001327': '5150d6bb3fbf03310a000073','517f16f0ad03786d160013eb': '5150d739617bf1390a00007f','517f1793f82c147316001369': '5150d739617bf1390a00007f','517f18a415b5456716001368': '5150d7de400a59290a00006a','517f18fcad03786d160013f5': '5150d7de400a59290a00006a','517e118ac66fa27916000f7f': '51524583b77a816255000014','517acc48c66fa27916000b12': '5158d4f785a3944755000027','517acccbad03786d16000b59': '5158d61cde0cab505500002f','517acd1c15b5456716000b20': '5158d61cde0cab505500002f','517acd62c66fa27916000b14': '5158d6eab77a81625500002b','517acd63f82c147316000b69': '5158d6eab77a81625500002b','517acdddad03786d16000b5c': '5158d8b985a394475500002f','517acedbc66fa27916000b18': '5158d90dde0cab5055000037','517acedcf82c147316000b6c': '5158d90dde0cab5055000037','517aceddad03786d16000b5d': '5158d90dde0cab5055000037','517ad073c66fa27916000b1b': '5158d9a0de0cab505500003b','517ad133c66fa27916000b1c': '5158da1685a3944755000038','517ad1b0ad03786d16000b65': '5158da6dfa5e0d595500003d','517ad25df82c147316000b74': '5158dac385a394475500003d','5176fce915b54567160006d3': '5176f8ecf82c1473160006ee','5193e721c66fa2791600d866': '5193e448f82c14731600d92b','5193e80f15b545671600d8f8': '5193e75d15b545671600d8f4','5193e830f82c14731600d934': '5193e75d15b545671600d8f4','5193e8f8ad03786d1600d88a': '5193e87515b545671600d8f9','5193e91d15b545671600d8fd': '5193e87515b545671600d8f9' }

midtermgradeboundaries = [97,93,90,87,83,80,77,73,70,67,63,60,0]

grades = ['A+','A','A-','B+','B','B-','C+','C','C-','D+','D','D-','F']

start = new Date(2013,2,31)

analytics.db.collection("midterm").group(
    {email:true}
    {type:"proberesponse"}
    {csum:0,count:0,score:0, maxscore:0}
    (obj,prev) -> 
        prev.csum+=obj.responsetime
        prev.count++
        prev.score+=obj.points
        prev.maxscore+=obj.totalanswerscorrect
    (out) ->
        out.avg_time = out.csum/out.count
        out.percent = out.score/out.maxscore
    (err, people) =>
        for person in people
            if person.email in students
                grade = grades[(person.score>=x for x in midtermgradeboundaries).indexOf(true)]
                api.db.collection("grade").save points: person.score, grade: grade, email: person.email, title: "Midterm"       
)

#mongoexport --db analytics --collection midterm -q '{"type":"proberesponse"}' -o midterm.json --jsonArray
